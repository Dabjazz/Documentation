---
custom_edit_url: null
---

import Image from '/src/components/Images.js';
import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';

# Part 1: Service LED

## 1. Introduction

The first step is to create your first Luos service. You can start with the [project](https://github.com/Luos-io/Mooc/tree/main/Basic_Project).

Until now, you have learned how to create your first project, how to integrate Luos into it, and how to upload the code to your MCU. However, in order to specify the functionality of your MCU, as well as to use the features of Luos technology, you need to create services.

:::info
A service is a block of code which provides a functionality. Services are able to communicate with any other service present in the Luos network.
:::

A service can be the driver of an hardware component that you want to use, or an application that defines only the software-oriented functionalities of your system.

You can fit multiple services into a single MCU.

The first service for this tutorial will be a Led driver. After this step, you will have integrated to your project a service that drives the LED on your Nucleo STM32F072RB board.

## 2. Create your source files

First, you need to create the code files in which you will write the code of your driver.

Create a folder named ‚ÄúLed‚Äù into the lib folder of your project where you will put all your driver's source files. This folder is called a package.

:::info
A package is a set of blocks of code that handles one or a group of functionalities, independent from the rest of the system. A package can have one or more services.
:::

Afterwards, you have to create four new files into the Led folder, with the following names *led.c*, *led.h*, *led_drv.c* and *led_drv.h*.

<div align="center">
  <Image src="/img/tutorials/morse/morse-1-1.png" height="300px" />
  <Image src="/img/tutorials/morse/morse-1-2.png" height="300px" />
</div>

We now have our Led library source files:

<div align="center">
  <Image src="/img/tutorials/morse/morse-1-3.png" height="300px" />
</div>

## 3. Create your first service

Now, you can go on with the creation of your first service.

The main functions of your service will be kept in the *led.c* source file. Each service, as previously implied by the Luos methodology, includes two principal functions in order to be integrated in a Luos project. These functions are an `Init()` and a `Loop()` function.

### Step 1: Create the main functions of your Led Driver in the *led.c* file.

```c
/******************************************************************************
 * @file Led
 * @brief driver example a simple Led
 * @author Luos
 * @version 0.0.0
 ******************************************************************************/
#include "led.h"

/*******************************************************************************
 * Definitions
 ******************************************************************************/

/*******************************************************************************
 * Variables
 ******************************************************************************/

/*******************************************************************************
 * Functions
 ******************************************************************************/

/******************************************************************************
 * @brief service init must be call in project init
 * @param None
 * @return None
 ******************************************************************************/
void Led_Init(void)
{
}
/******************************************************************************
 * @brief service loop must be call in project loop
 * @param None
 * @return None
 ******************************************************************************/
void Led_Loop(void)
{
}
```

So now, let‚Äôs work in the `Led_Init()` function.

:::tip
The services‚Äô initialization function should include the creation of the service along with every other variables that need to be initialized. It is only called once, at the beginning of the execution of the node.
:::

The function which creates a service is the following:

```c
/******************************************************************************
 * @brief API to Create a service
 * @param callback msg handler for the service
 * @param type of service corresponding to object dictionnary
 * @param alias for the service string (15 caracters max).
 * @param version FW for the service (tab[MajorVersion,MinorVersion,Patch])
 * @return service object pointer.
 ******************************************************************************/
service_t *Luos_CreateService(SERVICE_CB service_cb, uint8_t type, const char *alias, revision_t revision);
```

:::info

- The service callback is a function that is called when a new message, destined for this service, arrives.
- `type` is a parameter that defines a set of characteristics, shared among the services of the same type. You can find the list of all the Luos created types here, or you can define your own custom type, locally in your package code.
- `alias` is the name of your service. The alias is a characteristic which is unique for each service and gives you the opportunity of searching a specific service by its name (this feature will be explained later in this tutorial).
- `revision` is the firmware's version of our service. This can be used to check that the versions of each service in the network are up to date.

:::

In our case, we will create the function called `Led_MsgHandler()` that will be used as a callback to the service. This function will have as arguments the pointer to our service, and a pointer to the new message received.

Insert the `Led_MsgHandler()` function in the end of your `luos.c` file:

```c
/******************************************************************************
 * @brief Msg manager callback when a msg receive for the led service
 *        Led can receive messages commands of type COLOR
 * @param Service destination
 * @param Msg receive
 * @return None
 ******************************************************************************/
static void Led_MsgHandler(service_t *service, msg_t *msg)
{
    // Msg handling
}
```

In order to use it in `Led_Init()`, which is defined earlier in _luos.c_, we need to declare this function in the very beginning of our file:

```c
/*******************************************************************************
 * Functions
 ******************************************************************************/
static void Led_MsgHandler(service_t *service, msg_t *msg);
```

Now, we are ready to create our new service. 

```c
void Led_Init(void)
{
    // example revision
    revision_t revision = {.major = 1, .minor = 0, .build = 0};
    // Create Led service
    Luos_CreateService(Led_MsgHandler, STATE_TYPE, "led_service", revision);
}
```

We defined the type of our service as a **STATE_TYPE**, because the two values that the Nucleo board's LED can take is 1 for the LED ON and 0 for the LED OFF.

Finally **‚Äúled_service‚Äù** is the alias of our service, and **revision** is its previously specified firmware revision.

In this service, we do not have any algorithmic part so **we must leave `Led_Loop()` empty for the moment.**

The last step is to declare the two fundamental functions in the header file _led.h_, so that it can be used later by the main files of our project.

In *led.h*:

```c
/******************************************************************************
 * @file Led
 * @brief driver example a simple Led
 * @author Luos
 * @version 0.0.0
 ******************************************************************************/
#ifndef LED_H
#define LED_H

#include "luos.h"

/*******************************************************************************
 * Definitions
 ******************************************************************************/

/*******************************************************************************
 * Variables
 ******************************************************************************/

/*******************************************************************************
 * Function
 ******************************************************************************/
void Led_Init(void);
void Led_Loop(void);

#endif /* LED_H */
```

As seen above, we also need to include *luos.h* so that we are able to use the Luos APIs.

### Step 2: Create the hardware driving functions

Until now, we have created a new Luos service that is capable of being integrated to a Luos network, as well as communicating with the other services existing in the same network. Nevertheless, our service is not yet in the position of driving the LED's light of our board. For this reason, we need to **specify the driver's functions, in the source file *led_drv.c*.**

First of all, we need to **specify the GPIO pin and port of the LED** on the Nucleo STM32F072RB board, in the file *led_drv.h*.

The GPIO port corresponding to our LED port will be `GPIOA` and the pin corresponding to our LED pin will be `GPIO_PIN_5`.

If you are curious to learn more information about the hardware configuration method, check this [page](https://docs.luos.io/docs/hardware-consideration/mcu) üßê.

The two functions that we will use for our Led driver and that should be declared in the _led_drv.h_ file are:

```c
// initializes led driver
void LedDrv_Init();
// writes led value to the led pin
void LedDrv_Write(uint8_t value);
```

**Write the following code into the *led_drv.h* file:**

```c
/******************************************************************************
 * @file led_com
 * @brief communication driver
 * @author Luos
 * @version 0.0.0
 ******************************************************************************/
#ifndef LED_DRV_H
#define LED_DRV_H

#include "luos.h"
#include "stm32f0xx_hal.h"
/*******************************************************************************
 * Definitions
 ******************************************************************************/
#define LED_PIN  GPIO_PIN_5
#define LED_PORT GPIOA

/*******************************************************************************
 * Variables
 ******************************************************************************/

/*******************************************************************************
 * Function
 ******************************************************************************/

void LedDrv_Init();
void LedDrv_Write(uint8_t value);

#endif /* LED_DRV_H */
```

Open *led_driver.c* and include its header file called *led_drv.h*:

```c
/******************************************************************************
 * @file led_com
 * @brief communication driver
 * @author Luos
 * @version 0.0.0
 ******************************************************************************/
#include "led_drv.h"
/*******************************************************************************
 * Definitions
 ******************************************************************************/

/*******************************************************************************
 * Variables
 ******************************************************************************/

/*******************************************************************************
 * Function
 ******************************************************************************/
```

Create a new function that initializes the Led sriver in *led_drv.c*. In this function, we will first **enable the clock** that will be used and then we will initialize the GPIO struct with the information that corresponds to the LED light:

```c
/******************************************************************************
 * @brief Communication init must be called in Led_Init
 * @param None
 * @return None
 ******************************************************************************/
void LedDrv_Init(void)
{
    // Led Initialization
    GPIO_InitTypeDef GPIO_InitStruct = {0};

    __HAL_RCC_GPIOA_CLK_ENABLE();

    /*Configure GPIO pins : RxEN_Pin */
    GPIO_InitStruct.Pin   = LED_PIN;
    GPIO_InitStruct.Mode  = GPIO_MODE_OUTPUT_PP;
    GPIO_InitStruct.Pull  = GPIO_NOPULL;
    GPIO_InitStruct.Speed = GPIO_SPEED_FREQ_LOW;
    HAL_GPIO_Init(LED_PORT, &GPIO_InitStruct);
}
```

Then, we need to **create the `LedDrv_Write()` function**. This function is responsible of writing the value 1 or 0 on the LED pin in order to respectively light on or turn off the LED.

**Add the LED write function in the end of your *led_drv.c* file:**

```c
/******************************************************************************
 * @brief Led driver write function puts the color to the led
 * @param on/off value (1 or 0)
 * @return None
 ******************************************************************************/
void LedDrv_Write(uint8_t value)
{
    HAL_GPIO_WritePin(LED_PORT, LED_PIN, value);
}
```

### Step 3: Use the Led driver's functions into the *led.c* source file.

You can now use the functions created in the previous step into our fundamental LED functions.

**Return to *led.c* file and include the *led_drv.h* header file:**

```c
/******************************************************************************
 * @file Led
 * @brief driver example a simple Led
 * @author Luos
 * @version 0.0.0
 ******************************************************************************/
#include "led.h"
#include "led_drv.h"
/*******************************************************************************
 * Definitions
 ******************************************************************************/
```

**Call the driver initialization function `LedDrv_Init()` into the `Led_Init()` function:**

```c
void Led_Init(void)
{
    // example revision
    revision_t revision = {.major = 1, .minor = 0, .build = 0};
    // Initialization of Led Driver
    LedDrv_Init();
    // Create Led service
    Luos_CreateService(Led_MsgHandler, STATE_TYPE, "led_service", revision);
}
```

The last thing that we need to do, in order to change the LED's value, is to write the value to the LED pin each time we receive a message that demands the change of the LED state, by using `LedDrv_Write()` function.

As previously said, the services of a Luos network can communicate with each other by exchanging messages.

<div align="center">
  <Image
    src="/img/tutorials/morse/morse-1-4.png"
    darkSrc="/img/tutorials/morse/morse-1-4-dark.png"
  />
</div>

:::tip
The Luos messages follow a specific format. Each message, consists of the message header and the data.

Analytically:

```c
typedef struct{
    header_t header;
    uint8_t data[MAX_DATA_MSG_SIZE];
}msg_t;

typedef struct{
    uint16_t protocol : 4;    /*!< Protocol version. */
    uint16_t target : 12;     /*!< Target address, it can be (ID, Multicast/Broadcast, Type). */
    uint16_t target_mode : 4; /*!< Select targeting mode (ID, ID+ACK, Multicast/Broadcast, Type). */
    uint16_t source : 12;     /*!< Source address, it can be (ID, Multicast/Broadcast, Type). */
    uint8_t cmd;              /*!< msg definition. */
    uint16_t size;            /*!< Size of the data field. */
}header_t;
```

For more information about the message structure, see this [documentation page](/docs/luos-technology/message).

:::

In our project, the Led service can treat the messages of the command `IOSTATE`. This command shows that the message received contains 1 byte of data, with a value true or false (1 or 0), depending on the value the we want to write to the LED pin.

_For example: if someone wants to turn on the LED, they will receive a message of command `IOSTATE` targeting the LED, with data equal to the value 1._

It is now time to treat the messages received by the Led service.

**Add the following code into `Led_MsgHandler()` function in *led.c* file:**

```c
static void Led_MsgHandler(service_t *service, msg_t *msg)
{
    if (msg->header.cmd == IO_STATE)
    {
        // get state value from message
        uint8_t state = msg->data[0];
        // Send the state value to the led
        LedDrv_Write(state);
    }
}
```

You have now a Led Driver ready to be used in your first Luos project!

### Step 4: Integrate the Led Service into your project‚Äôs main files.

Following to the creation of the new service, you need to call its prior functions in your project‚Äôs main files.

Go back to the *main.c* file created into the *src* folder, and **include the *led.h* header file** at the beginning of your file:

```c
/******************************************************************************
 * @file main
 * @brief main file of the project
 * @author Yourself
 * @version 0.0.0
 ******************************************************************************/

#include "stm32f0xx_hal.h"
#include "luos.h"
#include "led.h"
```

Call the `Led_Init()` and `Led_Loop()` functions, right after the corresponding Luos functions into the `main()` function:

```c
/******************************************************************************
 * @brief main function
 * @param None
 * @return None
 ******************************************************************************/
int main(void)
{
    HAL_Init();
    SystemClock_Config();

    // Init
    Luos_Init();
    Led_Init();
    while (1)
    {
        // Loop
        Luos_Loop();
        Led_Loop();
    }
}
```

Finally, add the *lib* folder as an extra library dependency into the *platformio.ini* file:

```
lib_extra_dirs = lib/
```

After this addition, the file *platformio.ini* will look like this:

```
[env:nucleo_f072rb]
platform = ststm32
board = nucleo_f072rb
framework = stm32cube

build_unflags = -Os
build_flags =
    -include node_config.h
    -DUSE_HAL_DRIVER
    -DUSE_FULL_LL_DRIVER
    -DLUOSHAL=STM32F0
    -O1
lib_extra_dirs = lib/
lib_deps =
    Luos@^2.1.0
    LuosHAL
debug_tool = stlink
upload_protocol = stlink
```

Build your project and make sure that you have no errors.

**Congratulations! You have successfully created your first Luos service and integrated it into your project!**

